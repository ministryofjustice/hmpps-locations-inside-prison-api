{
  "id": "transactions",
  "name": "Location transaction reports",
  "description": "Reports detailing transactions made to internal locations",
  "metadata": {
    "author": "Michael Willis",
    "version": "1.0.0",
    "owner": "Move a prisoner team"
  },
  "datasource": [
    {
      "id": "irs",
      "name": "dataSource",
      "connection": "postgres"
    }
  ],
  "policy": [
    {
      "id": "access",
      "type": "access",
      "rule": [
        {
          "effect": "permit",
          "condition": [
            {
              "match": [
                "${role}",
                "MANAGE_RES_LOCATIONS_OP_CAP"
              ]
            }
          ]
        }
      ]
    },
    {
      "id": "caseloads",
      "type": "row-level",
      "action": ["prison_id IN (${caseloads})"],
      "rule": [
        {
          "effect": "permit",
          "condition": [
            {
              "exists": ["${caseloads}"]
            }
          ]
        }
      ]
    }
  ],
  "dataset": [
    {
      "id": "residential",
      "name": "Residential location transactions",
      "datasource": "dataSource",
      "query": "select tx.prison_id,\n       (case p.resi_location_service_active when true then 'Y' else 'N' end) as service_active,\n       tx.tx_start_time,\n       tx.transaction_type,\n       (CASE tx.transaction_type\n            WHEN 'LOCATION_CREATE' THEN 'Created residential location'\n            WHEN 'LOCATION_UPDATE' THEN 'Updated residential location'\n            WHEN 'LOCATION_CREATE_NON_RESI' THEN 'Created non-residential location'\n            WHEN 'LOCATION_UPDATE_NON_RESI' THEN 'Updated non-residential location'\n            WHEN 'CAPACITY_CHANGE' THEN 'Capacity change'\n            WHEN 'CELL_TYPE_CHANGES' THEN 'Cell type change'\n            WHEN 'DEACTIVATION' THEN 'Deactivation'\n            WHEN 'PERMANENT_DEACTIVATION' THEN 'Permanent deactivation'\n            WHEN 'REACTIVATION' THEN 'Reactivation'\n            WHEN 'CELL_CONVERTION_TO_ROOM' THEN 'Cell conversion to room'\n            WHEN 'ROOM_CONVERTION_TO_CELL' THEN 'Room conversion to cell'\n            WHEN 'SIGNED_OP_CAP' THEN 'Signed operational capacity'\n            WHEN 'RESI_SERVICE_ACTIVATION' THEN 'Residential service activation'\n            WHEN 'SYNC' THEN 'NOMIS sync (Residential)'\n            WHEN 'SYNC_NON_RESIDENTIAL' THEN 'NOMIS sync (Non-Residential)'\n            WHEN 'DELETE' THEN 'Locations deleted'\n            WHEN 'APPROVAL_PROCESS_ACTIVATION' THEN 'Certification approval activated'\n            WHEN 'PENDING_CELL_CHANGE' THEN 'Pending cell change'\n            WHEN 'REQUEST_CERTIFICATION_APPROVAL' THEN 'Request certification approval'\n            WHEN 'APPROVE_CERTIFICATION_REQUEST' THEN 'Approve request'\n            WHEN 'REJECT_CERTIFICATION_REQUEST' THEN 'Reject request'\n            WHEN 'WITHDRAW_CERTIFICATION_REQUEST' THEN 'Withdraw request'\n            ELSE 'Unknown transaction type' END)                             as transaction_description,\n       tx.transaction_detail,\n       tx.transaction_invoked_by,\n       (select COUNT(distinct location_id)\n        FROM location_history lh\n        where lh.linked_transaction_id = tx.id)                                 number_locations_affected,\n       (SELECT STRING_AGG(distinct l.path_hierarchy, ', ')\n        FROM location_history lh\n                 join location l on l.id = lh.location_id\n        where lh.linked_transaction_id = tx.id)                                 locations_affected\nfrom linked_transaction tx\n         left join prison_configuration p on p.prison_id = tx.prison_id",
      "schema": {
        "field": [
          {
            "name": "prison_id",
            "type": "string"
          },
          {
            "name": "service_active",
            "type": "string",
            "filter": {
              "type": "radio",
              "mandatory": true,
              "default": "Y",
              "staticoptions": [
                {
                  "name": "Y",
                  "display": "Active"
                },
                {
                  "name": "N",
                  "display": "Inactive"
                }
              ]
            }
          },
          {
            "name": "tx_start_time",
            "type": "datetime"
          },
          {
            "name": "transaction_type",
            "type": "string",
            "filter": {
              "type": "multiselect",
              "mandatory": true,
              "default": "LOCATION_CREATE,LOCATION_UPDATE,CAPACITY_CHANGE,CELL_TYPE_CHANGES,DEACTIVATION,PERMANENT_DEACTIVATION,REACTIVATION,CELL_CONVERTION_TO_ROOM,ROOM_CONVERTION_TO_CELL,SIGNED_OP_CAP,RESI_SERVICE_ACTIVATION",
              "staticoptions": [
                {"name": "LOCATION_CREATE", "display": "Created residential location"},
                {"name": "LOCATION_UPDATE", "display": "Updated residential location"},
                {"name": "LOCATION_CREATE_NON_RESI", "display": "Created non-residential location"},
                {"name": "LOCATION_UPDATE_NON_RESI", "display": "Updated non-residential location"},
                {"name": "CAPACITY_CHANGE", "display": "Capacity change"},
                {"name": "CELL_TYPE_CHANGES", "display": "Cell type change"},
                {"name": "DEACTIVATION", "display": "Deactivation"},
                {"name": "PERMANENT_DEACTIVATION", "display": "Permanent deactivation"},
                {"name": "REACTIVATION", "display": "Reactivation"},
                {"name": "CELL_CONVERTION_TO_ROOM", "display": "Cell conversion to room"},
                {"name": "ROOM_CONVERTION_TO_CELL", "display": "Room conversion to cell"},
                {"name": "SIGNED_OP_CAP", "display": "Signed operational capacity"},
                {"name": "RESI_SERVICE_ACTIVATION", "display": "Residential service activation"},
                {"name": "APPROVAL_PROCESS_ACTIVATION", "display": "Certification approval activation"},
                {"name": "PENDING_CELL_CHANGE", "display": "Certification approval activation"},
                {"name": "REQUEST_CERTIFICATION_APPROVAL", "display": "Request certification approval"},
                {"name": "APPROVE_CERTIFICATION_REQUEST", "display": "Approve request"},
                {"name": "REJECT_CERTIFICATION_REQUEST", "display": "Reject request"},
                {"name": "WITHDRAW_CERTIFICATION_REQUEST", "display": "Withdraw request"},
                {"name": "SYNC", "display": "NOMIS sync (Residential)"},
                {"name": "SYNC_NON_RESIDENTIAL", "display": "NOMIS sync (Non-Residential)"},
                {"name": "DELETE", "display": "Locations deleted"}
              ]
            }
          },
          {
            "name": "transaction_description",
            "type": "string"
          },
          {
            "name": "transaction_detail",
            "type": "string"
          },
          {
              "name": "transaction_invoked_by",
              "type": "string"
          },
          {
            "name": "number_locations_affected",
            "type": "int"
          },
          {
            "name": "locations_affected",
            "type": "string"
          }
        ]
      }
    },
    {
      "id": "cell-details",
      "name": "List of cell details",
      "datasource": "dataSource",
      "query": "select l.id, l.prison_id, concat(l.prison_id, '-', l.path_hierarchy) as path_hierarchy, initcap(l.local_name) as local_name, l.cell_mark,\n       (CHAR_LENGTH(l.path_hierarchy) - CHAR_LENGTH(REPLACE(l.path_hierarchy, '-', ''))) / CHAR_LENGTH('-') +1 as level,\n       c.certified_normal_accommodation,\n       c.working_capacity,\n       c.max_capacity,\n       initcap(l.location_type) as location_type,\n       initcap(l.status) as status,\n       (select string_agg( distinct INITCAP(replace(uf.used_for, '_', ' ')), ',') from cell_used_for uf where l.id = uf.location_id) used_for,\n       (select string_agg( distinct INITCAP(replace(sc.specialist_cell_type, '_', ' ')), ',') from specialist_cell sc where l.id = sc.location_id) specialist_types\n    from location l left join capacity c on l.capacity_id = c.id\n    join prison_configuration p on l.prison_id = p.prison_id\nwhere l.location_type_discriminator IN ('RESIDENTIAL', 'CELL')",
      "schema": {
        "field": [
          {
            "name": "id",
            "type": "string"
          },
          {
            "name": "prison_id",
            "type": "string"
          },
          {
            "name": "path_hierarchy",
            "type": "string"
          },
          {
            "name": "local_name",
            "type": "string"
          },
          {
            "name": "cell_mark",
            "type": "string"
          },
          {
            "name": "level",
            "type": "int"
          },
          {
            "name": "status",
            "type": "string",
            "filter": {
              "type": "multiselect",
              "mandatory": true,
              "default": "Active",
              "staticoptions": [
                {
                  "name": "Active",
                  "display": "Active"
                },
                {
                  "name": "Inactive",
                  "display": "Inactive"
                },
                {
                  "name": "Draft",
                  "display": "Draft"
                }
              ]
            }
          },
          {
            "name": "certified_normal_accommodation",
            "type": "int"
          },
          {
            "name": "working_capacity",
            "type": "int"
          },
          {
            "name": "max_capacity",
            "type": "int"
          },
          {
            "name": "location_type",
            "type": "string"
          },
          {
            "name": "used_for",
            "type": "string"
          },
          {
            "name": "specialist_types",
            "type": "string"
          }
        ]
      }
    }
  ],
  "report": [
    {
      "id": "residential",
      "name": "Residential location transactions",
      "description": "Details each transaction that has occurred in a residential location",
      "version": "1.0.0",
      "dataset": "$ref:residential",
      "policy": [],
      "render": "HTML",
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list",
        "field": [
          {
            "name": "$ref:prison_id",
            "display": "Prison ID",
            "sortable": true,
            "visible": "true",
            "defaultsort": false,
            "filter": {
              "type" : "caseloads",
              "mandatory": false
            }
          },
          {
            "name": "$ref:service_active",
            "display": "Service active",
            "sortable": false,
            "visible": "false",
            "defaultsort": false
          },
          {
            "name": "$ref:transaction_type",
            "display": "Transaction type",
            "sortable": false,
            "visible": "false",
            "defaultsort": false
          },
          {
            "name": "$ref:transaction_description",
            "display": "Transaction description",
            "sortable": false,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:tx_start_time",
            "display": "Transaction time",
            "formula": "format_date(${tx_start_time}, 'dd/MM/yyyy HH:mm')",
            "sortable": true,
            "visible": "true",
            "defaultsort": true,
            "filter": {
              "type": "daterange",
              "default": "today(-3,months) - today()"
            }
          },
          {
            "name": "$ref:transaction_detail",
            "display": "Details",
            "sortable": false,
            "visible": "true"
          },
          {
            "name": "$ref:transaction_invoked_by",
            "display": "Staff username",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:number_locations_affected",
            "display": "# locations affected",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:locations_affected",
            "display": "Locations affected",
            "sortable": false,
            "visible": "false",
            "defaultsort": false
          }
        ]
      },
      "destination": [],
      "summary": [{
        "id": "summaryId",
        "template": "page-header",
        "dataset": "$ref:residential"
      }]
    },
    {
      "id": "cell-details",
      "name": "List of cell details",
      "description": "Details each cell and its capacity and attributes",
      "version": "1.0.0",
      "dataset": "$ref:cell-details",
      "policy": [],
      "render": "HTML",
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list",
        "field": [
          {
            "name": "$ref:prison_id",
            "display": "Prison ID",
            "sortable": false,
            "visible": "true",
            "defaultsort": false,
            "filter": {
              "type" : "caseloads",
              "mandatory": false
            }
          },
          {
            "name": "$ref:path_hierarchy",
            "display": "Location path",
            "formula": "make_url('https://locations-inside-prison-${env}.hmpps.service.justice.gov.uk/view-and-update-locations/${prison_id}/${id}',${path_hierarchy},TRUE)",
            "sortable": true,
            "visible": "true",
            "defaultsort": true
          },
          {
            "name": "$ref:local_name",
            "display": "Local name",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:cell_mark",
            "display": "Door mark",
            "sortable": true,
            "visible": "false",
            "defaultsort": false
          },
          {
            "name": "$ref:level",
            "display": "Level",
            "sortable": true,
            "visible": "false",
            "defaultsort": false
          },
          {
            "name": "$ref:certified_normal_accommodation",
            "display": "CNA",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:working_capacity",
            "display": "Working capacity",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:max_capacity",
            "display": "Max capacity",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:location_type",
            "display": "Location type",
            "sortable": true,
            "visible": "false",
            "defaultsort": false
          },
          {
            "name": "$ref:used_for",
            "display": "Used for",
            "sortable": true,
            "visible": "true",
            "defaultsort": false,
            "wordwrap": "break-words"
          },
          {
            "name": "$ref:specialist_types",
            "display": "Specialist",
            "sortable": true,
            "visible": "true",
            "defaultsort": false,
            "wordwrap": "break-words"
          },
          {
            "name": "$ref:status",
            "display": "Status",
            "sortable": true,
            "visible": "false",
            "defaultsort": false
          }
        ]
      },
      "destination": [],
      "summary": [{
        "id": "cellSummaryId",
        "template": "page-header",
        "dataset": "$ref:cell-details"
      }]
    }
  ]
}
